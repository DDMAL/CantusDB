{% extends "base.html" %}
{% block content %}
<title>{{ chant.incipit }} | Cantus Manuscript Database</title>
<script src="/static/js/chant_detail.js"></script>

<div class="container">
    <div class="row">
        <div class="mr-3 p-3 col-lg-8 bg-white rounded">

            <!--Display "submit success" message -->
            {% if messages %}
                <div class="alert alert-success alert-dismissible">
                    {% for message in messages %}
                        {{ message }}
                    {% endfor %}
                </div>
            {% endif %}
            
            {% if user_can_edit_chant %}
                <p>
                    View | <a href="{% url 'source-edit-chants' chant.source.id %}?pk={{ chant.id }}&folio={{ chant.folio }}&ref=chant-detail">Edit</a>
                </p>
            {% endif %}
            
            <h3>{{ chant.incipit }}</h3>

            <dl>
                <div class="row">
                    {% if chant.source %}
                        <div class="col">
                            <dt>Source</dt>
                            <dd>
                                <a href="{% url 'source-detail' chant.source.id %}">{{ chant.source.title }}</a>
                            </dd>
                        </div>
                    {% endif %}

                    {% if chant.marginalia %}
                        <div class="col">
                            <dt> Marginalia</dt>
                            <dd>{{ chant.marginalia }}</dd>
                        </div>
                    {% endif %}
                </div>

                <div class="form-row">
                    {% if chant.folio %}
                        <div class="form-group col-lg-2  col-sm-6 col-6">
                            <dt>Folio</dt>
                            <dd>{{ chant.folio }}</dd>
                        </div>
                    {% endif %}

                    {% if chant.c_sequence is not None %} {# check that it isn't None, since sometimes c_sequence is 0 #}
                        <div class="form-group col-lg-2  col-sm-6 col-6">
                            <dt>Sequence</dt>
                            <dd>{{ chant.c_sequence }}</dd>
                        </div>
                    {% endif %}
                </div>
                
                <div class="form-row">
                    {% if chant.feast %}
                        <div class="form-group col-lg-2  col-sm-6 col-6">
                            <dt>Feast</dt>
                            <dd>
                                <a href="{% url 'feast-detail' chant.feast.id %}" title="{{ chant.feast.description }}">{{ chant.feast.name }}</a>
                            </dd>
                        </div>
                    {% endif %}
                
                    {% if chant.office %}
                        <div class="form-group col-lg-2 col-sm-6 col-6">
                            <dt>Office/Mass</dt>
                            <dd>
                                <a href="{% url 'office-detail' chant.office.id %}" title="{{ chant.office.description }}">{{ chant.office.name }}</a>
                            </dd>
                        </div>
                    {% endif %}
                
                    {% if chant.genre %}
                        <div class="form-group col-lg-2 col-sm-6 col-6">
                            <dt>Genre</dt>
                            <dd>
                                <a href="{% url 'genre-detail' chant.genre.id %}" title="{{ chant.genre.description }}">{{ chant.genre.name }}</a>
                            </dd>
                        </div>
                    {% endif %}
                
                    {% if chant.position %}
                        <div class="form-group col-lg-2 col-sm-6 col-6">
                            <dt>Position</dt>
                            <dd>{{ chant.position }}</dd>
                        </div>
                    {% endif %}
                
                    {% if chant.cantus_id %}
                        <div class="form-group col-lg-2 col-sm-6 col-6">
                            <dt>Cantus ID</dt>
                            <dd>
                                <a href="{{ chant.get_ci_url }}" target="_blank">
                                    {{ chant.cantus_id }}
                                </a>
                            </dd>
                        </div>
                    {% endif %}
                
                    {% if chant.mode %}
                        <div class="form-group col-lg-2 col-sm-6 col-6">
                            <dt>Mode</dt>
                            <dd>{{ chant.mode }}</dd>
                        </div>
                    {% endif %}
                </div>
                

                <div class="row">
                    {% if chant.finalis %}
                        <div class="col">
                            <dt>Finalis</dt>
                            <dd>{{ chant.finalis }}</dd>
                        </div>
                    {% endif %}

                    {% if chant.differentia %}
                        <div class="col">
                            <dt>Differentia</dt>
                            <dd>{{ chant.differentia }}</dd>
                        </div>
                    {% endif %}

                    {% if chant.diff_db %}
                        <div class="col">
                            <dt>Differentia&nbsp;Database</dt>
                            <dd>
                                {% if chant.diff_db.melodic_transcription %}
                                    <p style="font-family: volpiano; font-size:28px; margin-bottom: 0px;">{{ chant.diff_db.melodic_transcription }}</p>
                                {% endif %}
                                <a href="https://differentiaedatabase.ca/differentia/{{ chant.diff_db }}" target="_blank">
                                    {{ chant.diff_db }}
                                </a>
                            </dd>    
                        </div>
                    {% endif %}

                    {% if chant.chant_range %}
                        <div class="col">
                            <dt>Range</dt>
                            <dd>
                                <p style="font-family: volpiano; font-size:28px">{{ chant.chant_range }}</p>
                            </dd>
                        </div>
                    {% endif %}

                    {% if chant.addendum %}
                        <div class="col">
                            <dt>Addendum</dt>
                            <dd>{{ chant.addendum }}</dd>
                        </div>
                    {% endif %}

                    {% if chant.extra %}
                        <div class="col">
                            <dt>Extra</dt>
                            <dd>{{ chant.extra }}</dd>
                        </div>
                    {% endif %}
                </div>

                {% if user.is_authenticated %}
                    {% if chant.manuscript_full_text_std_spelling %}
                        {% if chant.manuscript_full_text_std_proofread %}
                            <dt>Manuscript Reading Full Text (standardized spelling)</dt>
                            <dd>{{ chant.manuscript_full_text_std_spelling }}</dd>
                        {% else %}
                            <dt>Manuscript Reading Full Text (standardized spelling)
                                <span style="font-weight:normal"><i> (not proofread)</i></span>
                            </dt>
                            <dd>{{ chant.manuscript_full_text_std_spelling }}</dd>
                        {% endif %}
                    {% endif %}
                {% else %}
                    {% if chant.manuscript_full_text_std_spelling and chant.manuscript_full_text_std_proofread %}
                        <dt>Manuscript Reading Full Text (standardized spelling)</dt>
                        <dd>{{ chant.manuscript_full_text_std_spelling }}</dd>
                    {% endif %}
                {% endif %}

                {% if user.is_authenticated %}
                    {% if chant.manuscript_full_text %}
                        {% if chant.manuscript_full_text_proofread %}
                            <dt>Manuscript Reading Full Text (MS spelling)</dt>
                            <dd>{{ chant.manuscript_full_text }}</dd>
                        {% else %}
                            <dt>Manuscript Reading Full Text (MS spelling)
                                <span style="font-weight:normal"><i> (not proofread)</i></span>
                            </dt>
                            <dd>{{ chant.manuscript_full_text }}</dd>
                        {% endif %}
                    {% endif %}
                {% else %}
                    {% if chant.manuscript_full_text and chant.manuscript_full_text_proofread %}
                        <dt>Manuscript Reading Full Text (MS spelling)</dt>
                        <dd>{{ chant.manuscript_full_text }}</dd>
                    {% endif %}
                {% endif %}

                {% if user.is_authenticated %}
                    {% if chant.volpiano %}
                        {% if chant.volpiano_proofread %}
                            <dt>Volpiano</dt>
                            <dd>
                                <p style="font-family: volpiano; font-size:36px">{{ chant.volpiano }}</p>
                            </dd>
                        {% else %}
                            <dt>Volpiano
                                <span style="font-weight:normal"><i> (not proofread)</i></span>
                            </dt>
                            <dd>
                                <p style="font-family: volpiano; font-size:36px">{{ chant.volpiano }}</p>
                            </dd>
                        {% endif%}
                    {% endif %}
                {% else %}
                    {% if chant.volpiano and chant.volpiano_proofread %}
                        <dt>Volpiano</dt>
                        <dd>
                            <p style="font-family: volpiano; font-size:36px">{{ chant.volpiano }}</p>
                        </dd>
                    {% endif %}
                {% endif %}
                    
                {% if chant.indexing_notes %}
                    <dt>Indexing Notes</dt>
                    <dd>{{ chant.indexing_notes }}</dd>
                {% endif %}

                {% if chant.volpiano %}
                    <div class="row">
                        <div class="col">
                            <dt>Melody with text</dt>
                            {% if chant.manuscript_syllabized_full_text %}
                                <p><small>Syllabification is based on saved syllabized text.</small></p>
                            {% endif %}
                            <dd>
                                {% for zip in syllabized_text_with_melody %}
                                    {% for syl_mel, syl_text in zip %}
                                        <span style="float: left">
                                            <div style="font-family: volpiano; font-size: 36px">{{ syl_mel }}</div>
                                            <!-- "mt" is margin at the top, so that the lowest note in volpiano don't overlap with text -->
                                            <div class="mt-2" style="font-size: 12px; "><pre>{{ syl_text }}</pre></div>
                                        </span>
                                    {% endfor %}
                                {% endfor %}
                            </dd>
                        </div>
                    </div>
                {% endif %}

                {% if chant.image_link %}
                    <dt>Image link</dt>
                    <dd>
                        <a href="{{ chant.image_link }}" target="_blank" style="word-break: break-all">{{ chant.image_link }}</a>
                    </dd>
                {% endif %}
            </dl>
            {% if chant.cantus_id %}
                <h4 id="concordances">List of concordances</h4>
                {% if concordances_loaded_successfully %}
                    <small>
                        Displaying <b>{{ concordances_count }}</b> concordance{{ concordances_count|pluralize }} from the following database{{ concordances_databases|pluralize }}
                        (Cantus ID <b><a href="http://cantusindex.org/id/{{ chant.cantus_id }}" target="_blank" title="{{ chant.cantus_id }} on Cantus Index">{{ chant.cantus_id }}</a></b>):
                        <table id="concordancesSummary" style="margin-bottom: 10px">
                            <tbody>
                                {% for database in concordances_databases %}
                                    <tr>
                                        <td>
                                            <a href="{{ database.base_url }}" target="_blank">
                                                {{ database.name }}
                                            </a>
                                            {% if database.initialism %}
                                                ({{ database.initialism }})
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if database.alternate_results_count_text %}
                                                <a href="{{ database.results_url }}" target="_blank" class="guillemet">
                                                    {{ database.alternate_results_count_text }}
                                                </a>
                                            {% else %}
                                                <a href="{{ database.results_url }}" target="_blank"><b>
                                                    {{ database.results_count }}</b> chant{{ database.results_count|pluralize }}
                                                </a>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </small>
                    <table id="concordanceTable" class="table table-responsive table-bordered table-sm small" style="table-layout: fixed; width: 100%;">
                        <thead>
                            <tr>
                                <th scope="col" class="text-wrap" style="width:15%" title="Siglum">Siglum</th>
                                <th scope="col" class="text-wrap" style="width:6%" title="Folio">Folio</th>
                                <th scope="col" class="text-wrap" style="width:23%" title="Incipit">Incipit</th>
                                <th scope="col" class="text-wrap" style="width:4%" title="Office"></th>
                                <th scope="col" class="text-wrap" style="width:4%" title="Genre"></th>
                                <th scope="col" class="text-wrap" style="width:4%" title="Position"></th>
                                <th scope="col" class="text-wrap" style="width:20%" title="Feast">Feast</th>
                                <th scope="col" class="text-wrap" style="width:7%" title="Mode">Mode</th>
                                <th scope="col" class="text-wrap" style="width:8%" title="Image Link">Image</th>
                                <th scope="col" class="text-wrap" style="width:9%" title="Database">DB</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for chant in concordances %}
                                <tr>
                                    <td>
                                        <a href="{{ chant.srclink }}" target="_blank">
                                        {{ chant.siglum }}
                                        </a>
                                    </td>
                                    <td>
                                        {{ chant.folio }}
                                    </td>
                                    <td>
                                        <a href="{{ chant.chantlink }}" target="_blank">
                                            {{ chant.incipit }}
                                        </a>
                                    </td>
                                    <td>
                                        {{ chant.office }}
                                    </td>
                                    <td>
                                        {{ chant.genre }}
                                    </td>
                                    <td>
                                        {{ chant.position }}
                                    </td>
                                    <td>
                                        {{ chant.feast }}
                                    </td>
                                    <td>
                                        {{ chant.mode }}
                                    </td>
                                    <td>
                                        {% if chant.image %}
                                            <a href="{{ chant.image }}" target="_blank">Image</a>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {{ chant.db }}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p>Cantus Database encountered an error while loading concordances
                        (Cantus ID <b><a href="http://cantusindex.org/id/{{ chant.cantus_id }}" target="_blank" title="{{ chant.cantus_id }} on Cantus Index">{{ chant.cantus_id }}</a></b>).
                    </p>
                {% endif %}
                <p>
                    <a href="#concordances" onclick="window.location.href = '#concordances'; window.location.reload(true);">Refresh concordances</a><br>
                </p>

                <h4>List of melodies</h4>
                <span id="melodyLoadingPrompt" style="display: none; color: #922"><b>Loading melodies...</b></span>
                <a id="melodyButton" href="#" class="guillemet" onclick="loadMelodies('{{ chant.cantus_id }}'); return false;">Display the melodies connected with this chant</a>
                <div id="melodyDiv"></div>        
            {% endif %}

        </div>

        <div class="col p-0 sidebar">
            <div class="search-bar">
                {% include "global_search_bar.html" %}
            </div>

            {% with source=chant.source %}
                <div class="card mb-3 w-100">
                    <div class="card-header">
                        <b>Source navigation</b>
                        <br>
                        {% if source %}
                            <a href="{% url 'source-detail' source.id %}" title="{{ source.title }}"> <b>{{ source.siglum }}</b> </a>
                        {% else %}
                            This chant is not associated with any source. 
                        {% endif %}                            
                    </div>

                    {% if source %}
                        <div class="card-body">
                            <small>
                                <!--a small selector of all folios of this source-->
                                <select name="folios" id="folioSelect" class="w-30" onchange="jumpToFolio('{{ source.id }}')">
                                    <option value="">Select a folio</option>
                                    {% for folio in folios %}
                                        {% if folio == chant.folio %}
                                            <option selected value="{{ folio }}">{{ folio }}</option>
                                        {% else %}
                                            <option value="{{ folio }}">{{ folio }}</option>
                                        {% endif %}
                                    {% endfor %}
                                </select>

                                {% if previous_folio %}
                                    <a href="{% url "chant-list" %}?source={{ source.id }}&folio={{ previous_folio }}">{{ previous_folio }} <</a>
                                {% endif %}
                                {% if next_folio %}
                                    &nbsp;<a href="{% url "chant-list" %}?source={{ source.id }}&folio={{ next_folio }}">> {{ next_folio }}</a>
                                {% endif %}

                                {% if chant.image_link %}
                                    <a href={{ chant.image_link }} class="guillemet" target="_blank">Display facsimile <b>({{ chant.folio }})</b></a>
                                {% endif %}

                                {% if previous_folio %}
                                    <br>
                                    <div id="previousDiv" style="display:none">
                                        {% for feast, chants in feasts_previous_folio %}
                                            Folio: <b>{{ previous_folio }}</b> - Feast: <b>{{ feast.name }}</b>
                                            <table class="table table-sm small table-bordered">     
                                                {% for chant in chants %}
                                                    <tr>
                                                        <td>
                                                            {{ chant.c_sequence }}
                                                        </td>
                                                        <td>
                                                            <span title="{{ chant.office.description }}">
                                                                {{ chant.office.name|default_if_none:"" }}
                                                            </span>
                                                            <b title="{{ chant.genre.description }}">{{ chant.genre.name|default_if_none:"" }}</b>
                                                            {{ chant.position|default_if_none:"" }}
                                                        </td>
                                                        <td>
                                                            <a href="{% url 'chant-detail' chant.id %}">
                                                                {{ chant.incipit|default_if_none:"" }}
                                                            </a>
                                                        </td>
                                                        <td>
                                                            <a href="{{ chant.get_ci_url }}" target="_blank">
                                                                {{ chant.cantus_id|default_if_none:"" }}
                                                            </a>
                                                        </td>
                                                    </tr>
                                                {% endfor %}
                                            </table>
                                        {% endfor %}
                                    </div>
                                    <a id="previousToggle" href="#" onclick="togglePrevious(); return false;">Display previous chants ▾</a>
                                {% endif %}
                                <br>
                                {% with chant.c_sequence as current_seq %}
                                    {% for feast, chants in feasts_current_folio %}
                                        Folio: <b>{{ chant.folio }}</b> - Feast: <b title="{{ feast.description }}">{{ feast.name }}</b>
                                        <table class="table table-sm small table-bordered">     
                                            {% for chant in chants %}
                                                <tr>
                                                    <td>
                                                        {{ chant.c_sequence }}
                                                    </td>
                                                    <td>
                                                        <span title="{{ chant.office.description }}">
                                                            {{ chant.office.name|default_if_none:"" }}
                                                        </span>
                                                        <b title="{{ chant.genre.description }}">{{ chant.genre.name|default_if_none:"" }}</b>
                                                        {{ chant.position|default_if_none:"" }}
                                                    </td>
                                                    <td>
                                                        <a href="{% url 'chant-detail' chant.id %}">
                                                            {% if chant.c_sequence == current_seq %}
                                                                <b>{{ chant.incipit|default_if_none:"" }}</b>
                                                            {% else %}
                                                                {{ chant.incipit|default_if_none:"" }}
                                                            {% endif %}
                                                        </a>
                                                    </td>
                                                    <td>
                                                        <a href="{{ chant.get_ci_url }}" target="_blank">
                                                            {{ chant.cantus_id|default_if_none:"" }}
                                                        </a>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </table>
                                    {% endfor %}
                                {% endwith %}

                                {% if next_folio %}
                                    <a id="nextToggle" href="#" onclick="toggleNext(); return false;">Display next chants ▾</a>
                                    <br>
                                    <div id="nextDiv" style="display:none">
                                        {% for feast, chants in feasts_next_folio %}
                                            Folio: <b>{{ next_folio }}</b> - Feast: <b title="{{ feast.description }}">{{ feast.name }}</b>
                                            <table class="table table-sm small table-bordered">     
                                                {% for chant in chants %}
                                                    <tr>
                                                        <td>
                                                            {{ chant.c_sequence }}
                                                        </td>
                                                        <td>
                                                            <span title="{{ chant.office.description }}">
                                                                {{ chant.office.name|default_if_none:"" }}
                                                            </span>
                                                            <b title="{{ chant.genre.description }}">{{ chant.genre.name|default_if_none:"" }}</b>
                                                            {{ chant.position|default_if_none:"" }}
                                                        </td>
                                                        <td>
                                                            <a href="{% url 'chant-detail' chant.id %}">
                                                                {{ chant.incipit|default_if_none:"" }}
                                                            </a>
                                                        </td>
                                                        <td>
                                                             <a href="{{ chant.get_ci_url }}" target="_blank">
                                                                {{ chant.cantus_id|default_if_none:"" }}
                                                            </a>
                                                        </td>
                                                    </tr>
                                                {% endfor %}
                                            </table>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </small>
                        </div>
                    {% endif %}
                </div>

                {% if source %}
                    <div class="card mb-3 w-100">
                        <div class="card-header">
                            <small><a href="/sources?segment={{ source.segment.id }}">{{ source.segment.name }}</a></small>
                            <br>
                            <span title="{{ source.title }}">{{ source.siglum }}</span>
                        </div>
                        <div class=" card-body">
                            <small>
                                {% if source.provenance.name %}
                                    Provenance: <b><a href="{% url 'provenance-detail' source.provenance.id %}">{{source.provenance.name}}</a></b>
                                    <br>
                                {% endif %}

                                {% if source.date %}
                                    Date: 
                                    {% for century in source.century.all %}
                                        <b>
                                            <a href="{% url 'century-detail' century.id %}">{{ century.name }}</a>
                                        </b>
                                    {% endfor %}
                                    |
                                    <b>{{ source.date|default_if_none:"" }}</b>
                                    <br>
                                {% endif %}

                                {% if source.cursus %}
                                    Cursus: <b>{{ source.cursus|default_if_none:"" }}</b>
                                    <br>
                                {% endif %}

                                {% if source.notation.exists %}
                                    <b>
                                        <a href="{% url 'notation-detail' source.notation.all.first.id %}">{{ source.notation.all.first.name }}</a>
                                    </b>
                                    <br>
                                {% endif %}

                                {% if source.inventoried_by.exists %}
                                    Inventoried by:
                                    <ul>
                                        {% for editor in source.inventoried_by.all %}
                                            <li>
                                                <a href="{% url 'user-detail' editor.id %}"><b>{{ editor.full_name }}</b></a>
                                                <br>
                                                {{ editor.institution|default_if_none:"" }}
                                            </li>
                                        {% endfor %}
                                    </ul>
                                {% endif %}

                                {% if source.proofreaders.exists %}
                                    Proofreader{{ source.proofreaders.all|pluralize }}:
                                    <br>
                                    <ul>
                                        {% for editor in source.proofreaders.all %}
                                            <li>
                                                <a href="{% url 'user-detail' editor.id %}"><b>{{ editor.full_name }}</b></a>
                                                <br>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                {% endif %}

                                {{ source.indexing_notes|default_if_none:"" }}
                                <br>
                                {% if source.created_by %}
                                    Contributor: <a href={% url 'user-detail' source.created_by.id %}><b>{{ source.created_by.full_name }}</b></a>
                                {% endif %}
                            </small>
                        </div>
                    </div>
                {% endif %}
            {% endwith %}
        </div>
    </div>
</div>
{% endblock %}