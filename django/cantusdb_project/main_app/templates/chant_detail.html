{% extends "base.html" %}
{% block content %}
<title>{{ chant.incipit }} | Cantus Manuscript Database</title>

<script>
    function togglePrevious(toggleID) {
        var x = document.getElementById("previous_div");
        var toggle = document.getElementById(toggleID);
        if (x.style.display === "none") {
            x.style.display = "block";
            toggle.innerHTML = "Hide previous chants";
        } else {
            x.style.display = "none";
            toggle.innerHTML = "Display previous chants";
        }
        }

    function toggleNext(toggleID) {
        var x = document.getElementById("next_div");
        var toggle = document.getElementById(toggleID);
        if (x.style.display === "none") {
            x.style.display = "block";
            toggle.innerHTML = "Hide next chants";
        } else {
            x.style.display = "none";
            toggle.innerHTML = "Display next chants";
        }
        }
</script>

<div class="container">
    <div class="row">
        <div class="mr-3 p-3 col-lg-8 bg-white rounded">
            <h3>{{ chant.incipit }}</h3>
            <dl>
                <div class="row">
                    <div class="col">
                        <dt>
                            Source
                        </dt>
                        <dd>
                            <a href="{{ chant.source.get_absolute_url }}">
                                {{ chant.source.title }}
                            </a>
                        </dd>
                    </div>
                    {% if chant.marginalia %}
                    <div class="col">
                        <dt>
                            Marginalia
                        </dt>
                        <dd>
                            {{ chant.marginalia }}
                        </dd>
                    </div>
                    {% endif %}
                </div>

                <div class="row">
                    {% if chant.folio %}
                    <div class="col">
                        <dt>
                            Folio
                        </dt>
                        <dd>
                            {{ chant.folio }}
                        </dd>
                    </div>
                    {% endif %}
                    <div class="col">
                        {% comment %} {% if chant.sequence_number %} {% endcomment %}
                        <dt>
                            Sequence
                        </dt>
                        <dd>
                            {{ chant.sequence_number }}
                        </dd>
                        {% comment %} {% endif %} {% endcomment %}
                    </div>
                </div>
                
                <div class="row">
                    {% if chant.feast %}
                    <div class="col">
                        <dt>
                            Feast
                        </dt>
                        <dd>
                            <a href="{{ chant.feast.get_absolute_url }}">{{ chant.feast.name }}</a>
                        </dd>
                    </div>
                    {% endif %}
                    {% if chant.office %}
                    <div class="col">
                        <dt>
                            Office/Mass
                        </dt>
                        <dd>
                            <a href="{{ chant.office.get_absolute_url }}">{{ chant.office.name }}</a>
                        </dd>
                    </div>
                    {% endif %}
                    {% if chant.genre %}
                    <div class="col">
                        <dt>
                            Genre
                        </dt>
                        <dd>
                            <a href="{{ chant.genre.get_absolute_url }}">{{ chant.genre.name }}</a>
                        </dd>
                    </div>
                    {% endif %}
                    {% if chant.position %}
                    <div class="col">
                        <dt>
                            Position
                        </dt>
                        <dd>
                            {{ chant.position }}
                        </dd>
                    </div>
                    {% endif %}
                    {% if chant.cantus_id %}
                    <div class="col">
                        <dt>
                            Cantus ID
                        </dt>
                        <dd>
                            {{ chant.cantus_id }}
                        </dd>
                    </div>
                    {% endif %}
                    {% if chant.mode %}
                    <div class="col">
                        <dt>
                            Mode
                        </dt>
                        <dd>
                            {{ chant.mode }}
                        </dd>
                    </div>
                    {% endif %}
                </div>

                <div class="row">
                    {% if chant.finalis %}
                    <div class="col">
                        <dt>
                            Finalis
                        </dt>
                        <dd>
                            {{ chant.finalis }}
                        </dd>
                    </div>
                    {% endif %}
                    {% if chant.differentia %}
                    <div class="col">
                        <dt>
                            Differentia
                        </dt>
                        <dd>
                            {{ chant.differentia }}
                        </dd>
                    </div>
                    {% endif %}
                    {% if chant.addendum %}
                    <div class="col">
                        <dt>
                            Addendum
                        </dt>
                        <dd>
                            {{ chant.addendum }}
                        </dd>
                    </div>
                    {% endif %}
                    {% if chant.extra %}
                    <div class="col">
                        <dt>
                            Extra
                        </dt>
                        <dd>
                            {{ chant.extra }}
                        </dd>
                    </div>
                    {% endif %}
                </div>

                {% if chant.manuscript_full_text_std_spelling %}
                <dt>
                    Manuscript Reading Full Text (standardized spelling)
                </dt>
                <dd>
                    {{ chant.manuscript_full_text_std_spelling }}
                </dd>
                {% endif %}
                {% if chant.manuscript_full_text %}
                <dt>
                    Manuscript Reading Full Text (MS spelling)
                </dt>
                <dd>
                    {{ chant.manuscript_full_text }}
                </dd>
                {% endif %}
                {% if chant.chant_range %}
                <dt>
                    Range
                </dt>
                <dd>
                    <p style="font-family: volpiano; font-size:30px">
                        {{ chant.chant_range }}
                    </p>
                </dd>
                {% endif %}
                {% if chant.volpiano %}
                <dt>
                    Volpiano
                </dt>
                <dd>
                    <p style="font-family: volpiano; font-size:30px">
                        {{ chant.volpiano }}
                    </p>
                </dd>
                {% endif %}
                {% if chant.indexing_notes %}
                <dt>
                    Indexing Notes
                </dt>
                <dd>
                    {{ chant.indexing_notes }}
                </dd>
                {% endif %}
                {% if chant.volpiano and chant.manuscript_full_text %}
                <dt>
                    Melody with text
                </dt>
                <!-- TODO: figure out how to silabilize the text and align with melody -->
                <dd>
                    <p style="font-family: volpiano; font-size:30px">
                        {{ chant.volpiano }}
                    </p>
                    <p>
                        {{ chant.manuscript_syllabized_full_text }}
                    </p>
                </dd>
                {% endif %}

                {% if chant.image_link %}
                <dt>
                    Image link
                </dt>
                <dd>
                    <a href="{{ chant.image_link }}" target="_blank">{{ chant.image_link }}</a>
                </dd>
                {% endif %}
            </dl>

            <h4>List of concordances</h4>
            <a id="ajax_concordance" href="#">Display all concordances of this chant</a>
            <div id="concordance_div"></div>

            <br>
            <h4>List of melodies</h4>
            <a href="#" onclick="">Display the melodies connected with this chant</a>


            <script>
            const concordanceTable = document.getElementById('concordance_div')
            const ajaxConcordance = () => {
                $.ajax({
                    type: "GET", 
                    url: "/ajax/{{ chant.cantus_id }}",
                    success: function(response){
                        const concordances = response.concordances;
                        const concordanceCount = response.concordance_count;
                        // document.getElementById("test").innerHTML = cantus_id.toString();
                        concordanceTable.innerHTML += `Displaying <b>${concordanceCount}</b> concordances from the following databases (Cantus ID <b>{{ chant.cantus_id }})</b>`;
                        concordanceTable.innerHTML += `<table id="concordanceTable" class="table table-responsive table-sm small">
                                                            <thead>
                                                                <tr>
                                                                    <th scope="col" class="text-wrap">Siglum</th>
                                                                    <th scope="col" class="text-wrap">Folio</th>
                                                                    <th scope="col" class="text-wrap">Incipit</th>
                                                                    <th scope="col" class="text-wrap">Office </th>
                                                                    <th scope="col" class="text-wrap">Genre </th>
                                                                    <th scope="col" class="text-wrap">Position</th>
                                                                    <th scope="col" class="text-wrap">Feast</th>
                                                                    <th scope="col" class="text-wrap">Mode</th>
                                                                    <th scope="col" class="text-wrap">Image</th>
                                                                    <th scope="col" class="text-wrap">DB</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                            </tbody>
                                                        </table>`;
                        const table = document.getElementById("concordanceTable").getElementsByTagName("tbody")[0];
                        concordances.map(chant=>{
                            // console.log(chant.siglum)
                            const newRow = table.insertRow(table.rows.length);
                            if (chant.siglum) {newRow.innerHTML += `<td class="text-wrap"><a href="${chant.source_link}">${chant.siglum}</a></td>`} else {newRow.innerHTML += '<td class="text-wrap"></td>'}
                            if (chant.folio) {newRow.innerHTML += `<td class="text-wrap">${chant.folio}</td>`}
                            if (chant.incipit) {newRow.innerHTML += `<td class="text-wrap"><a href="${chant.chant_link}">${chant.incipit}</a></td>`}
                            if (chant.office__name) {newRow.innerHTML += `<td class="text-wrap">${chant.office__name}</td>`}
                            if (chant.genre__name) {newRow.innerHTML += `<td class="text-wrap">${chant.genre__name}</td>`}
                            if (chant.position) {newRow.innerHTML += `<td class="text-wrap">${chant.position}</td>`} else {newRow.innerHTML += '<td class="text-wrap"></td>'}
                            if (chant.feast__name) {newRow.innerHTML += `<td class="text-wrap">${chant.feast__name}</td>`}
                            if (chant.mode) {newRow.innerHTML += `<td class="text-wrap">${chant.mode}</td>`} else {newRow.innerHTML += '<td class="text-wrap"></td>'}
                            if (chant.image_link) {newRow.innerHTML += `<td class="text-wrap"><a href="${chant.image_link}" target="_blank">Image</a></td>`} else {newRow.innerHTML += '<td class="text-wrap"></td>'}
                            newRow.innerHTML += `<td class="text-wrap">${chant.db}</td>`
                        });
                        document.getElementById("concordance_div").innerHTML += "<a href='//cantusindex.org/ci/{{ chant.cantus_id }}?c=1&refresh=1' target='_blank'>Refresh results</a>";
                        document.getElementById("ajax_concordance").style.display = "none";
                    },
                    error: function(error){
                        document.getElementById("concordance_div").innerHTML = "Error when displaying the concordances"
                    }
                });
            }
            document.getElementById("ajax_concordance").addEventListener("click", ()=>{
                ajaxConcordance()
            })
            </script>



            <br>
            <a href="" class="btn btn-primary" id="delete">Delete this Chant</a>
            <script>
                window.onload = function () {
                    document.getElementById("delete").href = window.location.href + '/delete';
                }
            </script>

        </div>

        <div class="col">
            <div class="row">
            <!-- global search bar-->
            {% include "global_search_bar.html" %}
            </div>

            <div class="row">
                {% with source=chant.source %}
                <div class="card mb-3 w-100">
                    <div class="card-header">
                        <b>Source navigation</b>
                        <br>
                        <a href="{{ source.get_absolute_url }}"> <b>{{ source.siglum }}</b> </a>
                    </div>

                    <div class="card-body">
                        <small>
                            <!--a small selector of all folios of this source-->
                            <select name="folios" id="folio-select" class="w-30" onchange="jumpSource()">
                                <option value="#">Select a folio</option>
                                {% for folio in folios %}
                                    {% if folio == chant.folio %}
                                        <option selected value="#">{{ folio }}</option>
                                    {% else %}
                                        <option value="#">{{ folio }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>

                            {% if previous_folio %}
                                <a href="#">{{ previous_folio }} <</a>
                            {% endif %}
                            {% if next_folio %}
                                <a href="#">> {{ next_folio }}</a>
                            {% endif %}

                            {% if previous_folio %}
                                <br>
                                <div id="previous_div" style="display:none">
                                    {% for feast, chants in feasts_previous_folio %}
                                        Folio: <b>{{ previous_folio }}</b> - Feast: <b>{{ feast.name }}</b>
                                        <table class="table table-responsive table-sm small table-bordered">     
                                            {% for chant in chants %}
                                                <tr>
                                                    <td>{{ chant.sequence_number }}</td>
                                                    <td>{{ chant.office.name|default_if_none:"" }} <b>{{ chant.genre.name|default_if_none:"" }}</b> {{ chant.position|default_if_none:"" }} </td>
                                                    <td><a href="{{ chant.get_absolute_url }}">{{ chant.incipit|default_if_none:"" }}</a></td>
                                                    <td><a href="{{ chant.get_ci_url }}" target="_blank">{{ chant.cantus_id|default_if_none:"" }}</a></td>
                                                </tr>
                                            {% endfor %}
                                        </table>
                                    {% endfor %}
                                </div>
                                <a id="previous_toggle" onclick="togglePrevious(this.id)" href="#">Display previous chants</a>
                            {% endif %}
                            <br>


                            {% for feast, chants in feasts_current_folio %}
                                Folio: <b>{{ chant.folio }}</b> - Feast: <b>{{ feast.name }}</b>
                                <table class="table table-responsive table-sm small table-bordered">     
                                    {% for chant in chants %}
                                        <tr>
                                            <td>{{ chant.sequence_number }}</td>
                                            <td>{{ chant.office.name|default_if_none:"" }} <b>{{ chant.genre.name|default_if_none:"" }}</b> {{ chant.position|default_if_none:"" }} </td>
                                            <td><a href="{{ chant.get_absolute_url }}">{{ chant.incipit|default_if_none:"" }}</a></td>
                                            <td><a href="{{ chant.get_ci_url }}" target="_blank">{{ chant.cantus_id|default_if_none:"" }}</a></td>
                                        </tr>
                                    {% endfor %}
                                </table>
                            {% endfor %}

                            {% if next_folio %}
                                {% comment %} <button class="btn btn-primary" id="load-btn">NEXT CHANTS</button> {% endcomment %}
                                <a id="next_toggle" href="#" onclick="toggleNext(this.id)">Display next chants</a>
                                <br>

                                <div id="next_div" style="display:none">
                                    {% for feast, chants in feasts_next_folio %}
                                        Folio: <b>{{ next_folio }}</b> - Feast: <b>{{ feast.name }}</b>
                                        <table class="table table-responsive table-sm small table-bordered">     
                                            {% for chant in chants %}
                                                <tr>
                                                    <td>{{ chant.sequence_number }}</td>
                                                    <td>{{ chant.office.name|default_if_none:"" }} <b>{{ chant.genre.name|default_if_none:"" }}</b> {{ chant.position|default_if_none:"" }} </td>
                                                    <td><a href="{{ chant.get_absolute_url }}">{{ chant.incipit|default_if_none:"" }}</a></td>
                                                    <td><a href="{{ chant.get_ci_url }}" target="_blank">{{ chant.cantus_id|default_if_none:"" }}</a></td>
                                                </tr>
                                            {% endfor %}
                                        </table>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endwith %}
{% endblock %}