{% extends "base.html" %}
{% block content %}
<title>Search Chants | Cantus Manuscript Database</title>
<script src="/static/js/chant_search.js"></script>

<div class="mr-3 p-3 col-md-12 mx-auto bg-white rounded">
    <!-- global search bar-->
    <object align="right">
        {% include "global_search_bar.html" %}
    </object>
    <h3>Search Chants</h3>
    {% if source %}
        <b>Searching in source: <a href="{{ source.get_absolute_url }}" target="_blank">{{ source.title }}</a></b>
    {% endif %}

    {% if chants.all %}
        <small>Displaying {{ page_obj.start_index }}-{{ page_obj.end_index }} of <b>{{ page_obj.paginator.count }}
                chants</b></small>
    {% endif %}

    <form method="get">
        <div class="form-row align-items-end">
            <div class="form-group m-1 col-lg">
                <select class="form-control custom-select custom-select-sm" id="opFilter" name="op">
                    <option selected value="contains">Contains</option>
                    <option value="starts_with">Starts with</option>
                </select>
            </div>
            <div class="form-group m-1 col-lg">
                <label for="keywordSearch"><small>Keyword search</small></label>
                <input type="text" class="form-control form-control-sm" name="keyword" id="keywordSearch" value="{{ request.GET.keyword }}">
            </div>
        </div>
        <div class="form-row align-items-end">
            <div class="form-group m-1 col-lg">
                <label for="office"><small>Office/Mass</small></label>
                <input type="text" class="form-control form-control-sm" name="office" id="office" value="{{ request.GET.office }}">
            </div>
            <div class="form-group m-1 col-lg">
                <label for="genreFilter"><small>Genre</small></label>
                <select id="genreFilter" name="genre" class="form-control custom-select custom-select-sm">
                    <option value="">- Any -</option>
                    {% for genre in genres %}
                        <option value="{{ genre.id }}">{{ genre.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group m-1 col-lg">
                <label for="cantus_id"><small>Cantus ID</small></label>
                <input type="text" class="form-control form-control-sm" name="cantus_id" id="cantus_id" value="{{ request.GET.cantus_id }}">
            </div>
            <div class="form-group m-1 col-lg">
                <label for="mode"><small>Mode</small></label>
                <input type="text" class="form-control form-control-sm" name="mode" id="mode" value="{{ request.GET.mode }}">
            </div>
            <div class="form-group m-1 col-lg">
                <label for="feast"><small>Feast</small></label>
                <input type="text" class="form-control form-control-sm" name="feast" id="feast" value="{{ request.GET.feast }}">
            </div>
            <div class="form-group m-1 col-lg">
                <label for="position"><small>Position</small></label>
                <input type="text" class="form-control form-control-sm" name="position" id="position" value="{{ request.GET.position }}">
            </div>
            <div class="form-group m-1 col-lg">
                <label for="melodiesFilter"><small>Melodies</small></label>
                <select class="form-control custom-select custom-select-sm" id="melodiesFilter" name="melodies">
                    <option value="">- Any -</option>
                    <option value="true">Chants with melodies</option>
                    <option value="false">Chants without melodies</option>
                </select>
            </div>
        </div>

        <div class="form-row align-items-end">
            <div class="form-group m-1 col-lg">
                <button type="submit" class="btn btn-dark btn-sm" id="btn-submit"> Apply </button>
            </div>
        </div>
        
    </form>

    {% if chants.all %}
        <small>
            <table class="table table-sm small table-bordered">
                <thead>
                    <tr>
                        <th scope="col" class="text-wrap" style="text-align:center">
                            {% if order == "siglum" %}
                                {% if sort == "desc" %}
                                    <a href="{{ url_with_search_params }}&order=siglum&sort=asc">Siglum</a> ▼
                                {% else %}
                                    <a href="{{ url_with_search_params }}&order=siglum&sort=desc">Siglum</a> ▲
                                {% endif %}
                            {% else %}
                                <a href="{{ url_with_search_params }}&order=siglum&sort=asc">Siglum</a>
                            {% endif %}
                        </th>
                        <th scope="col" class="text-wrap" style="text-align:center">
                            Folio
                        </th>
                        <th scope="col" class="text-wrap" style="text-align:center">
                            {% if order == "incipit" %}
                                {% if sort == "desc" %}
                                    <a href="{{ url_with_search_params }}&order=incipit&sort=asc">Incipit/Full Text</a> ▼
                                {% else %}
                                    <a href="{{ url_with_search_params }}&order=incipit&sort=desc">Incipit/Full Text</a> ▲
                                {% endif %}
                            {% else %}
                                <a href="{{ url_with_search_params }}&order=incipit&sort=asc">Incipit/Full Text</a>
                            {% endif %}
                        </th>
                        <th scope="col" class="text-wrap" style="text-align:center">
                            Feast
                        </th>
                        <th scope="col" class="text-wrap" style="text-align:center">
                            {% if order == "office" %}
                                {% if sort == "desc" %}
                                    <a href="{{ url_with_search_params }}&order=office&sort=asc">Office<br>/Mass</a> ▼
                                {% else %}
                                    <a href="{{ url_with_search_params }}&order=office&sort=desc">Office<br>/Mass</a> ▲
                                {% endif %}
                            {% else %}
                                <a href="{{ url_with_search_params }}&order=office&sort=asc">Office<br>/Mass</a>
                            {% endif %}
                        </th>
                        <th scope="col" class="text-wrap" style="text-align:center">
                            {% if order == "genre" %}
                                {% if sort == "desc" %}
                                    <a href="{{ url_with_search_params }}&order=genre&sort=asc">Genre</a> ▼
                                {% else %}
                                    <a href="{{ url_with_search_params }}&order=genre&sort=desc">Genre</a> ▲
                                {% endif %}
                            {% else %}
                                <a href="{{ url_with_search_params }}&order=genre&sort=asc">Genre</a>
                            {% endif %}
                        </th>
                        <th scope="col" class="text-wrap" style="text-align:center">
                            Position
                        </th>
                        <th scope="col" class="text-wrap" style="text-align:center">
                            {% if order == "cantus_id" %}
                                {% if sort == "desc" %}
                                    <a href="{{ url_with_search_params }}&order=cantus_id&sort=asc">Cantus ID</a> ▼
                                {% else %}
                                    <a href="{{ url_with_search_params }}&order=cantus_id&sort=desc">Cantus ID</a> ▲
                                {% endif %}
                            {% else %}
                                <a href="{{ url_with_search_params }}&order=cantus_id&sort=asc">Cantus ID</a>
                            {% endif %}
                        </th>
                        <th scope="col" class="text-wrap" style="text-align:center">
                            {% if order == "mode" %}
                                {% if sort == "desc" %}
                                    <a href="{{ url_with_search_params }}&order=mode&sort=asc">Mode</a> ▼
                                {% else %}
                                    <a href="{{ url_with_search_params }}&order=mode&sort=desc">Mode</a> ▲
                                {% endif %}
                            {% else %}
                                <a href="{{ url_with_search_params }}&order=mode&sort=asc">Mode</a>
                            {% endif %}
                        </th>
                        <th scope="col" class="text-wrap" style="text-align:center">
                            {% if order == "has_fulltext" %}
                                {% if sort == "desc" %}
                                    <a href="{{ url_with_search_params }}&order=has_fulltext&sort=asc">MsFt</a> ▼
                                {% else %}
                                    <a href="{{ url_with_search_params }}&order=has_fulltext&sort=desc">MsFt</a> ▲
                                {% endif %}
                            {% else %}
                                <a href="{{ url_with_search_params }}&order=has_fulltext&sort=asc">MsFt</a>
                            {% endif %}
                        </th>
                        <th scope="col" class="text-wrap" style="text-align:center">
                            {% if order == "has_melody" %}
                                {% if sort == "desc" %}
                                    <a href="{{ url_with_search_params }}&order=has_melody&sort=asc">Mel</a> ▼
                                {% else %}
                                    <a href="{{ url_with_search_params }}&order=has_melody&sort=desc">Mel</a> ▲
                                {% endif %}
                            {% else %}
                                <a href="{{ url_with_search_params }}&order=has_melody&sort=asc">Mel</a>
                            {% endif %}
                        </th>
                        <th scope="col" class="text-wrap" style="text-align:center">
                            {% if order == "has_image" %}
                                {% if sort == "desc" %}
                                    <a href="{{ url_with_search_params }}&order=has_image&sort=asc">Image</a> ▼
                                {% else %}
                                    <a href="{{ url_with_search_params }}&order=has_image&sort=desc">Image</a> ▲
                                {% endif %}
                            {% else %}
                                <a href="{{ url_with_search_params }}&order=has_image&sort=asc">Image</a>
                            {% endif %}
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for chant in chants %}
                        <tr>
                            <td class="text-wrap" style="text-align:left">
                                <a href="{{ chant.source.get_absolute_url }}">{{ chant.source.siglum }}</a>
                            </td>
                            <td class="text-wrap" style="text-align:center">
                                {{ chant.folio|default:""|truncatechars_html:140 }}
                            </td>

                            <td class="text-wrap" style="text-align:left">
                                {% comment %} this is used for distinguishing chants from sequences,
                                if the object is chant, use chant.get_absolute_url,
                                otherwise, use sequence.get_absolute_url
                                the combined queryset turned all objects into chants
                                so this is the only way to make the distinction {% endcomment %}
                                {% if chant.search_vector %}
                                    <b><a href="{{ chant.get_absolute_url }}">{{ chant.incipit|default:"" }}</a></b>
                                {% else %}
                                    <b><a href="{% url 'sequence-detail' chant.id %}">{{ chant.incipit|default:"" }}</a></b>
                                {% endif %}
                                <p>
                                    {{ chant.manuscript_full_text_std_spelling|default:""|truncatewords_html:100 }}
                                </p>           
                            </td>
                            <td class="text-wrap" style="text-align:center">
                                <a href="{{ chant.feast.get_absolute_url }}">{{ chant.feast.name|default:"" }}</a>
                            </td>
                            <td class="text-wrap" style="text-align:center">
                                <a href="{{ chant.office.get_absolute_url }}">{{ chant.office.name|default:"" }}</a>
                            </td>
                            <td class="text-wrap" style="text-align:center">
                                <a href="{{ chant.genre.get_absolute_url }}">{{ chant.genre.name|default:"" }}</a>
                            </td>
                            <td class="text-wrap" style="text-align:center">
                                {{ chant.position|default:"" }}
                            </td>
                            <td class="text-wrap" style="text-align:center">
                                <a href="{{ chant.get_ci_url }}" target="_blank">{{chant.cantus_id|default:"" }}</a>
                            </td>
                            <td class="text-wrap" style="text-align:center">
                                {{ chant.mode|default:"" }}
                            </td>
                            <td class="text-wrap" style="text-align:center">
                                {% if chant.manuscript_full_text %}
                                    <span title="Chant record includes Manuscript Full Text">✔</span>
                                {% endif %}
                            </td>
                            <td class="text-wrap" style="text-align:center">
                                {% if chant.volpiano %}
                                    <span title="Chant record has Volpiano melody">♫</span>
                                {% endif %}
                            </td>
                            <td class="text-wrap" style="text-align:center">
                                {% if chant.image_link %}
                                    <a href="{{ chant.image_link }}" target="_blank">Image</a>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </small>

        {% include "pagination.html" %}
    {% endif %}
</div>
        
{% endblock %}
